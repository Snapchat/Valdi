name: PR Size Labeler

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  size-label:
    name: Label PR by Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Calculate PR size and apply label
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName !== 'pull_request' || !context.payload.pull_request) {
              console.log('Skipping: not a pull_request event or no pull_request in payload');
              return;
            }
            const pr = context.payload.pull_request;
            
            // Get ALL files changed in the PR (handles pagination automatically)
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            console.log(`Found ${files.length} changed files`);
            
            // Calculate total lines changed (additions + deletions)
            let totalChanges = 0;
            for (const file of files) {
              totalChanges += file.additions + file.deletions;
            }
            
            // Determine size category
            let sizeLabel;
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 250) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 1000) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }
            
            console.log(`Total changes: ${totalChanges} lines`);
            console.log(`Size label: ${sizeLabel}`);
            
            // Get existing labels
            const existingLabels = pr.labels.map(label => label.name);
            
            // Remove old size labels
            const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];
            const labelsToRemove = existingLabels.filter(label => 
              sizeLabels.includes(label) && label !== sizeLabel
            );
            
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label,
              });
              console.log(`Removed label: ${label}`);
            }
            
            // Add new size label if not already present
            if (!existingLabels.includes(sizeLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [sizeLabel],
              });
              console.log(`Added label: ${sizeLabel}`);
            }
            
            // Add a comment with size breakdown (only on first run)
            if (context.payload.action === 'opened') {
              const filesList = files
                .sort((a, b) => (b.additions + b.deletions) - (a.additions + a.deletions))
                .slice(0, 10)
                .map(f => `- \`${f.filename}\`: +${f.additions} -${f.deletions}`)
                .join('\n');
              
              const comment = `## ðŸ“Š PR Size: **${sizeLabel}**

**Total changes:** ${totalChanges} lines (${files.length} files)

**Top files changed:**
${filesList}${files.length > 10 ? `\n\n_...and ${files.length - 10} more files_` : ''}

<sub>Size calculated as additions + deletions. Labels: XS (<10), S (<50), M (<250), L (<1000), XL (1000+)</sub>`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment,
              });
            }
