name: Comment Test Results

on:
  workflow_call:
    inputs:
      workflow_name:
        description: 'Name of the calling workflow for the comment header'
        required: true
        type: string
      success_message:
        description: 'Message to show when all tests pass'
        required: false
        type: string
        default: '**All tests passed!** ‚ú®'
      failure_message:
        description: 'Message to show when tests fail'
        required: false
        type: string
        default: '**Some tests failed.** Please check the workflow logs for details.'
      additional_info:
        description: 'Optional additional information to include in the comment'
        required: false
        type: string
        default: ''

permissions:
  pull-requests: write

jobs:
  comment:
    name: Post Results Comment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Auto-detect jobs and comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch all jobs for this workflow run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            // Build results table (exclude this comment job itself)
            let tableRows = [];
            let allPassed = true;
            
            for (const job of jobs.data.jobs) {
              // Skip the comment job itself
              if (job.name === 'Post Results Comment' || job.name === 'Comment Test Results') {
                continue;
              }
              
              const icon = job.conclusion === 'success' ? '‚úÖ' : '‚ùå';
              tableRows.push(`| ${job.name} | ${icon} ${job.conclusion} |`);
              
              if (job.conclusion !== 'success') {
                allPassed = false;
              }
            }
            
            const emoji = allPassed ? 'üéâ' : '‚ö†Ô∏è';
            const message = allPassed 
              ? `${{ inputs.success_message }}`
              : `${{ inputs.failure_message }}`;
            
            const additionalInfo = `${{ inputs.additional_info }}`;
            
            const body = `## ${emoji} ${{ inputs.workflow_name }}
            
            | Test Suite | Result |
            |------------|--------|
            ${tableRows.join('\n')}
            
            ${message}
            
            ${additionalInfo ? additionalInfo + '\n\n' : ''}
            <sub>Workflow: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})</sub>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
